name: Automatically
run-name: dp-dp-nxtleap-rebase-1
on:
    workflow_dispatch:
jobs:
    fetch-branches:
      runs-on: ubuntu-latest
      outputs:
        branches: ${{ steps.get-branches.outputs.branches }}
      
      steps:
          - name: Checkout repository
            uses: actions/checkout@v2
            with:
              token: ${{ secrets.GITHUB_TOKEN }}

          - name: Update remote references and fetch
            run: |
              git remote set-head origin --auto
              git fetch --all --prune
        
          - name: List branches
            run: |
              git branch -r
      
          - name: Get all branches except develop and main
            id: get-branches
            run: |
              DEFAULT_BRANCH=develop 
              BRANCHES=$(git branch -r | grep -vE "origin/($DEFAULT_BRANCH|main|HEAD)" | sed 's@^ *origin/@@')
              echo "$BRANCHES" 
      
              if [ -z "$BRANCHES" ]; then
                echo "If No branches are found then exit."
                exit 1 
              fi

              BRANCH_SEPERATED=$(echo $BRANCHES | tr ' \n' ',' | sed 's/,$//')
              echo "$BRANCH_SEPERATED"
              BRANCH_LIST=$(echo $BRANCH_SEPERATED | jq -R -s -c 'split(",") | map(gsub("^[[:space:]]+|[[:space:]]+$";"")) | map(select(length > 0))' | sed 's/\\n//g')
              echo "Branches List: $BRANCH_LIST" 
              echo "branches=$BRANCH_LIST" >> $GITHUB_OUTPUT

    rebase-branches:
      needs: fetch-branches
      runs-on: ubuntu-latest
      strategy:
        matrix:
          branch: ${{ fromJSON(needs.fetch-branches.outputs.branches) }}
          
      steps:
        - name: Checkout repository
          uses: actions/checkout@v2
          with:
            token: ${{ secrets.GITHUB_TOKEN }}

        - name: Fetch all branches
          run: |
            echo "Fetching all remote branches..."
            git fetch --all --prune
    
        - name: Verify branch existence
          run: |
            echo "Verifying branch existence..."
            if ! git show-ref --verify --quiet refs/remotes/origin/${{ matrix.branch }}; then
              echo "Branch 'origin/${{ matrix.branch }}' does not exist. Exiting..."
              exit 1
            fi

        - name: List branches
          run: |
            git branch -r

        
        - name: Print just names
          run: |
            git checkout ${{ matrix.branch }}
            git fetch origin
            CURRENT_BRANCH=${{ matrix.branch }}
            # Assuming 'develop' or 'main' as potential parent branches
            POTENTIAL_PARENTS=["develop","main"]
            PARENT_BRANCH=""
        
            for BRANCH in "${POTENTIAL_PARENTS}"; do
                if git show-ref --verify --quiet refs/remotes/origin/$BRANCH; then
                MERGE_BASE=$(git merge-base origin/$CURRENT_BRANCH origin/$BRANCH)
                if [ "$(git log -1 --pretty=%H origin/$BRANCH)" = "$MERGE_BASE" ]; then
                    PARENT_BRANCH=$BRANCH
                    break
                fi
                fi
            done
        
            if [ -z "$PARENT_BRANCH" ]; then
                echo "No parent branch found. Defaulting to 'develop'."
                PARENT_BRANCH="develop"
            fi
        
            echo "parent_branch: $PARENT_BRANCH"
            echo "PARENT_BRANCH=$PARENT_BRANCH"
        